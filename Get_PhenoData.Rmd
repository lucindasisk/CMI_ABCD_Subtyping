---
title: "Get_ABCD_CMI_Pheno_Data"
author: "Lucinda Sisk"
date: "2/11/2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(hablar)
```

```{r, tidy=TRUE}

sample1 <- read_csv('/Users/lucindasisk/Dropbox/CANDLab/Projects/CMI_Structural_ABCD/Data/CMI_ABCD_Sample1_IDs.csv') 
sample2 <- read_csv('/Users/lucindasisk/Dropbox/CANDLab/Projects/CMI_Structural_ABCD/Data/CMI_ABCD_Sample2_IDs.csv')

samples <- rbind(sample1, sample2) %>% 
    arrange(subjectkey)

abcd_ptsd <- read_tsv('/Users/lucindasisk/Desktop/ABCD/ABCDstudyNDA-2.0/abcd_ptsd01.txt') %>% 
    mutate("subjectkey" = str_remove(subjectkey, "_")) %>% 
    filter(eventname == "baseline_year_1_arm_1") %>% 
    right_join(samples, by="subjectkey") %>% 
    arrange(subjectkey)

fha1 <- read_tsv('/Users/lucindasisk/Desktop/ABCD/ABCDstudyNDA-2.0/fhxp102.txt') %>% 
    mutate("subjectkey" = str_remove(subjectkey, "_")) %>% 
    filter(eventname == "baseline_year_1_arm_1") %>% 
    right_join(samples, by="subjectkey") %>% 
    arrange(subjectkey)

fha2 <- read_tsv('/Users/lucindasisk/Desktop/ABCD/ABCDstudyNDA-2.0/fhxp201.txt') %>% 
    mutate("subjectkey" = str_remove(subjectkey, "_")) %>% 
    filter(visit == "baseline_year_1_arm_1") %>% 
    right_join(samples, by="subjectkey") %>% 
    arrange(subjectkey)

# demo <- read_tsv('/Users/lucindasisk/Desktop/ABCD/ABCDstudyNDA-2.0/pdem02.txt') %>% 
#     mutate("subjectkey" = str_remove(subjectkey, "_")) %>% 
#     #filter(eventname == "baseline_year_1_arm_1") %>% 
#     right_join(samples, by="subjectkey") %>% 
#     arrange(subjectkey)

ce_sumscores_y <- read_tsv('/Users/lucindasisk/Desktop/ABCD/ABCDstudyNDA-2.0/abcd_sscey01.txt') %>% 
    mutate("subjectkey" = str_remove(subjectkey, "_")) %>% 
    filter(eventname == "baseline_year_1_arm_1") %>% 
    right_join(samples, by="subjectkey") %>% 
    arrange(subjectkey)

ce_sumscores_p <- read_tsv('/Users/lucindasisk/Desktop/ABCD/ABCDstudyNDA-2.0/abcd_sscep01.txt') %>% 
    mutate("subjectkey" = str_remove(subjectkey, "_")) %>% 
    filter(eventname == "baseline_year_1_arm_1") %>% 
    inner_join(samples, by="subjectkey") %>% 
    arrange(subjectkey)

```

```{r, tidy=TRUE}

phys_ab <- abcd_ptsd %>% 
    select("subjectkey", "ksads_ptsd_raw_761_p","ksads_ptsd_raw_762_p","ksads_ptsd_raw_763_p") %>% 
    type_convert(col_types = cols(ksads_ptsd_raw_761_p ="i",
                                  ksads_ptsd_raw_762_p = "i",
                                  ksads_ptsd_raw_763_p = "i")) %>% 
    mutate(physical_abuse_sum = rowSums(.[2:4])) %>% 
    select("subjectkey", "physical_abuse_sum")
    #mutate(physical_abuse_bin = recode(physical_abuse, "2" = "1", "3" = "1")) #Recode sums to binary score (max 5 score)
    
sex_ab <- abcd_ptsd %>% 
    select("subjectkey", "ksads_ptsd_raw_767_p","ksads_ptsd_raw_768_p", "ksads_ptsd_raw_769_p") %>% 
    type_convert(col_types = cols(ksads_ptsd_raw_767_p ="i",
                                  ksads_ptsd_raw_768_p = "i",
                                  ksads_ptsd_raw_769_p = "i")) %>% 
    mutate(sexual_abuse_sum = rowSums(.[2:4])) %>% 
    select("subjectkey", "sexual_abuse_sum")
    #mutate(sexual_abuse_bin = recode(sexual_abuse, "2" = "1", "3" = "1")) #Recode sums to binary score (max 5 score)

# dom_violence <- abcd_ptsd %>% 
#     select("subjectkey", "ksads_ptsd_raw_766_p") %>% 
#     type_convert(col_types = cols(ksads_ptsd_raw_767_p ="i")) %>% 
#     rename(domestic_violence_sum = "ksads_ptsd_raw_766_p") %>% 
#     select("subjectkey", "domestic_violence_sum")

exp_violence <- abcd_ptsd %>% 
    select("subjectkey", "ksads_ptsd_raw_758_p", "ksads_ptsd_raw_759_p", "ksads_ptsd_raw_760_p", "ksads_ptsd_raw_764_p", "ksads_ptsd_raw_765_p") %>% 
    type_convert(col_types = cols(ksads_ptsd_raw_758_p = "i",
                                  ksads_ptsd_raw_759_p = "i",
                                  ksads_ptsd_raw_760_p ="i",
                                  ksads_ptsd_raw_764_p = "i",
                                  ksads_ptsd_raw_765_p ="i")) %>% 
    mutate(exposure_violence_sum = rowSums(.[2:6])) %>% 
    select("subjectkey", "exposure_violence_sum")
    #mutate(exposure_violence_bin = recode(exposure_violence, "2" = "1", "3" = "1", "4" = "1", "5" = "1")) #Recode sums to binary score (max 5 score)
                     
    
trauma_other <- abcd_ptsd %>% 
    select("subjectkey", "ksads_ptsd_raw_754_p","ksads_ptsd_raw_755_p", "ksads_ptsd_raw_756_p", "ksads_ptsd_raw_757_p", "ksads_ptsd_raw_766_p", "ksads_ptsd_raw_770_p") %>% 
    type_convert(col_types = cols(ksads_ptsd_raw_754_p ="i",
                                  ksads_ptsd_raw_755_p = "i",
                                  ksads_ptsd_raw_756_p = "i",
                                  ksads_ptsd_raw_757_p ="i",
                                  ksads_ptsd_raw_766_p= "i",
                                  ksads_ptsd_raw_770_p = "i")) %>% 
    mutate(trauma_other_sum = rowSums(.[2:7])) %>% 
    select("subjectkey", "trauma_other_sum")
    #mutate(trauma_other_bin = recode(trauma_other, "2" = "1", "3" = "1", "4" = "1", "5" = "1")) #Recode sums to binary score (max 5 score)

# divorce <- demo %>%  #### Binary variable - not including
#     select("subjectkey", "demo_prnt_marital_v2") %>% 
#     mutate(marital_div_sep = recode(demo_prnt_marital_v2, "2" = "1", "3" = "1", "4" = "1", "1" = "0", "5" = "0", "6" = "0")) %>% 
#     # 12= Widowed, 3 = Divorced, 4 = Separated; convert all to "1"
#     dplyr::na_if("777") %>% 
#     select("subjectkey", "marital_div_sep")

crpbi_parent_mean <- ce_sumscores_y %>% #Acceptance Subscale, Youth Report Mean (on parent)
    select("subjectkey", "crpbi_y_ss_parent")

crpbi_caregiver_mean <- ce_sumscores_y %>% #Acceptance Subscale, Youth Report Mean (on secondary caregiver)
    select("subjectkey", "crpbi_y_ss_caregiver")
    
pmq_mean <- ce_sumscores_y %>% #Parental Monitoring: Youth Report Mean
    select("subjectkey", "pmq_y_ss_mean")

school_environment <- ce_sumscores_y %>% #SRPF School Environment Subscale, Sum (youth report)
    select("subjectkey", "srpf_y_ss_ses")

# discrim <- ce_sumscores_y %>% #Perceived discrimination measure (youth report)
#     select("subjectkey", "dim_y_ss_mean")

nb_safety <- ce_sumscores_p %>% #Perceived discrimination measure (youth report)
    select("subjectkey", "nsc_p_ss_mean_3_items")

fam_conflict_parent <- ce_sumscores_p %>% #Perceived discrimination measure (youth report)
    select("subjectkey", "fes_p_ss_fc")

# fam_conflict_youth <- ce_sumscores_y %>% #Perceived discrimination measure (youth report)
#     select("subjectkey","fes_y_ss_fc")


```

```{r, tidy=TRUE}
alc_prob <- fha1 %>% 
    select("subjectkey", "famhx_4d_p___0", "famhx4a_p___0", "q4k_full_sib_young1_alc___0",
           "q4k_full_sib_young2_alc___0", "q4k_full_sib_young3_alc___0", "q4k_full_sib_young4_alc___0",
           "q4k_full_sib_young5_alc___0", "q4l_full_sib_old1_alc___0", "q4l_full_sib_old2_alc___0", 
           "q4l_full_sib_old3_alc___0","q4l_full_sib_old4_alc___0", "q4l_full_sib_old5_alc___0") %>% 
    dplyr::na_if("777") %>% 
    dplyr::na_if("999") %>% 
    convert(int(c("famhx_4d_p___0", "famhx4a_p___0", "q4k_full_sib_young1_alc___0",
           "q4k_full_sib_young2_alc___0", "q4k_full_sib_young3_alc___0",
           "q4k_full_sib_young4_alc___0","q4k_full_sib_young5_alc___0",
           "q4l_full_sib_old1_alc___0", "q4l_full_sib_old2_alc___0", "q4l_full_sib_old3_alc___0",
           "q4l_full_sib_old4_alc___0", "q4l_full_sib_old5_alc___0"))) %>% 
    mutate(alc_prob_sum = rowSums(.[2:13], na.rm=TRUE)) %>% 
    select("subjectkey", "alc_prob_sum")

drug_prob <- fha1 %>% 
    select("subjectkey","fam_history_q5a_drugs___0", "fam_history_q5d_drugs___0",
           "q5k_full_sib_young1_drugs___0", "q5k_full_sib_young2_drugs___0", 
           "q5k_full_sib_young3_drugs___0", "q5k_full_sib_young4_drugs___0",
           "q5k_full_sib_young5_drugs___0", "q5l_full_sib_old1_drugs___0", 
           "q5l_full_sib_old2_drugs___0", "q5l_full_sib_old3_drugs___0", 
           "q5l_full_sib_old4_drugs___0", "q5l_full_sib_old5_drugs___0") %>% 
    dplyr::na_if("777") %>% 
    dplyr::na_if("999") %>% 
    convert(int(c("fam_history_q5a_drugs___0", "fam_history_q5d_drugs___0", 
                  "q5k_full_sib_young1_drugs___0", "q5k_full_sib_young2_drugs___0",
                  "q5k_full_sib_young3_drugs___0", "q5k_full_sib_young4_drugs___0",
                  "q5k_full_sib_young5_drugs___0", "q5l_full_sib_old1_drugs___0",
                  "q5l_full_sib_old2_drugs___0", "q5l_full_sib_old3_drugs___0", 
                  "q5l_full_sib_old4_drugs___0", "q5l_full_sib_old5_drugs___0"))) %>% 
    mutate(drug_prob_sum = rowSums(.[2:13], na.rm=TRUE)) %>% 
    select("subjectkey", "drug_prob_sum")

depression_fh <- fha1 %>% 
    select("subjectkey","fam_history_q6a_depression", "fam_history_q6d_depression", 
           "q6k_full_sib_young1_depression", "q6k_full_sib_young2_depression", 
           "q6k_full_sib_young3_depression", "q6k_full_sib_young4_depression",
           "q6k_full_sib_young5_depression", "q6n_half_sib_old1_depression", 
           "q6n_half_sib_old2_depression", "q6n_half_sib_old3_depression", 
           "q6n_half_sib_old4_depression", "q6n_half_sib_old5_depression") %>% 
    dplyr::na_if("777") %>% 
    dplyr::na_if("999") %>% 
     convert(int(c("fam_history_q6a_depression", "fam_history_q6d_depression",
                   "q6k_full_sib_young1_depression","q6k_full_sib_young2_depression", 
                   "q6k_full_sib_young3_depression", "q6k_full_sib_young4_depression",
                   "q6k_full_sib_young5_depression", "q6n_half_sib_old1_depression", 
                   "q6n_half_sib_old2_depression","q6n_half_sib_old3_depression", 
                   "q6n_half_sib_old4_depression", "q6n_half_sib_old5_depression"))) %>% 
    mutate(depression_sum = rowSums(.[2:13], na.rm=TRUE)) %>% 
    select("subjectkey", "depression_sum")

mania_fh <- fha2 %>% 
    select("subjectkey", "fam_history_q7a_mania", "fam_history_q7d_mania", "q7k_full_sib_young1_mania",
           "q7k_full_sib_young2_mania", "q7k_full_sib_young3_mania", "q7k_full_sib_young4_mania",
           "q7k_full_sib_young5_mania", "q7l_full_sib_old1_mania", "q7l_full_sib_old2_mania",
           "q7l_full_sib_old3_mania", "q7l_full_sib_old4_mania", "q7l_full_sib_old5_mania") %>% 
    dplyr::na_if("777") %>% 
    dplyr::na_if("999") %>% 
    convert(int(c("fam_history_q7a_mania", "fam_history_q7d_mania", "q7k_full_sib_young1_mania",
           "q7k_full_sib_young2_mania", "q7k_full_sib_young3_mania", "q7k_full_sib_young4_mania",
           "q7k_full_sib_young5_mania", "q7l_full_sib_old1_mania", "q7l_full_sib_old2_mania",
           "q7l_full_sib_old3_mania", "q7l_full_sib_old4_mania", "q7l_full_sib_old5_mania"))) %>% 
    mutate(mania_sum = rowSums(.[2:13], na.rm=TRUE)) %>% 
    select("subjectkey", "mania_sum")

schiz_fh <- fha2 %>% 
    select("subjectkey", "fam_history_q8a_visions", "fam_history_q8d_visions", "q8k_full_sib_young1_visions",
           "q8k_full_sib_young2_visions", "q8k_full_sib_young3_visions", "q8k_full_sib_young4_visions",
           "q8k_full_sib_young5_visions", "q8l_full_sib_old1_visions", "q8l_full_sib_old2_visions",
           "q8l_full_sib_old3_visions", "q8l_full_sib_old4_visions", "q8l_full_sib_old5_visions") %>% 
    dplyr::na_if("777") %>% 
    dplyr::na_if("999") %>% 
    convert(int(c("fam_history_q8a_visions", "fam_history_q8d_visions", "q8k_full_sib_young1_visions",
           "q8k_full_sib_young2_visions", "q8k_full_sib_young3_visions", "q8k_full_sib_young4_visions",
           "q8k_full_sib_young5_visions", "q8l_full_sib_old1_visions", "q8l_full_sib_old2_visions",
           "q8l_full_sib_old3_visions", "q8l_full_sib_old4_visions", "q8l_full_sib_old5_visions"))) %>% 
    mutate(schiz_sum = rowSums(.[2:13], na.rm=TRUE)) %>% 
    select("subjectkey","schiz_sum")

crim_fh <- fha2 %>% 
    select("subjectkey", "fam_history_q9a_trouble", "fam_history_q9d_trouble", 
           "q9k_full_sib_young1_trouble", "q9k_full_sib_young2_trouble", 
           "q9k_full_sib_young3_trouble", "q9k_full_sib_young4_trouble",
           "q9k_full_sib_young5_trouble", "q9l_full_sib_old1_trouble", "q9l_full_sib_old2_trouble",
           "q9l_full_sib_old3_trouble", "q9l_full_sib_old4_trouble", "q9l_full_sib_old5_trouble") %>% 
    dplyr::na_if("777") %>% 
    dplyr::na_if("999") %>% 
    convert(int(c("fam_history_q9a_trouble", "fam_history_q9d_trouble", "q9k_full_sib_young1_trouble",
           "q9k_full_sib_young2_trouble", "q9k_full_sib_young3_trouble", "q9k_full_sib_young4_trouble",
           "q9k_full_sib_young5_trouble", "q9l_full_sib_old1_trouble", "q9l_full_sib_old2_trouble",
           "q9l_full_sib_old3_trouble", "q9l_full_sib_old4_trouble", "q9l_full_sib_old5_trouble"))) %>% 
    mutate(criminal_sum = rowSums(.[2:13], na.rm=TRUE)) %>% 
    select("subjectkey", "criminal_sum")

anx_fh <- fha2 %>% 
    select("subjectkey", "fam_history_q10a_nerves", "fam_history_q10d_nerves", "q10k_full_sib_young1_nerves", 
           "q10k_full_sib_young2_nerves", "q10k_full_sib_young3_nerves", "q10k_full_sib_young4_nerves",
           "q10k_full_sib_young5_nerves", "q10l_full_sib_old1_nerves", "q10l_full_sib_old2_nerves",
           "q10l_full_sib_old3_nerves", "q10l_full_sib_old4_nerves", "q10l_full_sib_old5_nerves") %>% 
    dplyr::na_if("777") %>% 
    dplyr::na_if("999") %>% 
    convert(int(c("fam_history_q10a_nerves", "fam_history_q10d_nerves", "q10k_full_sib_young1_nerves", 
           "q10k_full_sib_young2_nerves", "q10k_full_sib_young3_nerves", "q10k_full_sib_young4_nerves",
           "q10k_full_sib_young5_nerves", "q10l_full_sib_old1_nerves", "q10l_full_sib_old2_nerves",
           "q10l_full_sib_old3_nerves", "q10l_full_sib_old4_nerves", "q10l_full_sib_old5_nerves"))) %>% 
    mutate(anxious_sum = rowSums(.[2:13], na.rm=TRUE)) %>% 
    select("subjectkey", "anxious_sum")
    
suicide_fh <- fha2 %>% 
    select("subjectkey", "fam_history_q13a_suicide", "fam_history_q13d_suicide", "q13k_full_sib_young1_suicide",
           "q13k_full_sib_young2_suicide", "q13k_full_sib_young3_suicide", "q13k_full_sib_young4_suicide",
           "q13k_full_sib_young5_suicide", "q13l_full_sib_old1_suicide", "q13l_full_sib_old2_suicide",
           "q13l_full_sib_old3_suicide", "q13l_full_sib_old4_suicide", "q13l_full_sib_old5_suicide") %>% 
    dplyr::na_if("777") %>% 
    dplyr::na_if("999") %>% 
    convert(int(c("fam_history_q13a_suicide", "fam_history_q13d_suicide", "q13k_full_sib_young1_suicide",
           "q13k_full_sib_young2_suicide", "q13k_full_sib_young3_suicide", "q13k_full_sib_young4_suicide",
           "q13k_full_sib_young5_suicide", "q13l_full_sib_old1_suicide", "q13l_full_sib_old2_suicide",
           "q13l_full_sib_old3_suicide", "q13l_full_sib_old4_suicide", "q13l_full_sib_old5_suicide"))) %>% 
    mutate(suicide_sum = rowSums(.[2:13], na.rm=TRUE)) %>% 
    select("subjectkey", "suicide_sum")

substance_fh <- full_join(alc_prob, drug_prob) %>% 
    mutate(substance_sum = rowSums(.[2:3])) %>% 
    select("subjectkey","substance_sum")

m1 <- full_join(depression_fh, mania_fh)
m2 <- full_join(schiz_fh, anx_fh)
criminal_fh <- crim_fh

mentalhealth_fh <- full_join(m1, m2) %>%
    full_join(suicide_fh) %>% 
    mutate(mentalhealth_sum = rowSums(.[2:6])) %>% 
    select("subjectkey","mentalhealth_sum")

```


```{r, tidy=TRUE}
# Create final data frame
final_join <- full_join(phys_ab, sex_ab, by="subjectkey") %>% 
    full_join(exp_violence, by="subjectkey") %>% 
    full_join(trauma_other, by="subjectkey") %>% 
    full_join(mentalhealth_fh, by="subjectkey") %>% 
    full_join(substance_fh, by="subjectkey") %>% 
    full_join(criminal_fh, by="subjectkey") %>% 
    full_join(crpbi_parent_mean, by="subjectkey") %>% 
    full_join(crpbi_caregiver_mean, by="subjectkey") %>% 
    full_join(pmq_mean, by="subjectkey") %>% 
    full_join(school_environment, by="subjectkey") %>% 
    full_join(nb_safety, by="subjectkey") %>% 
    full_join(fam_conflict_parent, by="subjectkey") %>% 
    mutate("subjectkey" = str_remove(subjectkey, "_"))


final_sample_1 <- merge(sample1, final_join, all.x=TRUE, all.y=FALSE)
final_sample_2 <- inner_join(sample2, final_join)

```

```{r, tidy=TRUE}

write_csv(final_sample_1, '/Users/lucindasisk/Dropbox/CANDLab/Projects/CMI_Structural_ABCD/Data/LS_PhenoData_Sample1_2.13.19.csv')
write_csv(final_sample_2, '/Users/lucindasisk/Dropbox/CANDLab/Projects/CMI_Structural_ABCD/Data/LS_PhenoData_Sample2_2.13.19.csv')
```

```{r, tidy=TRUE}

f <- abcd_ptsd %>% 
    select(subjectkey, gender) %>% 
    right_join(sample1) %>% 
    filter(gender == "F")

```
