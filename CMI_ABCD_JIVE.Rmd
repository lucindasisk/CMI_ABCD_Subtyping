---
title: "CMI_ABCD_JIVE"
author: "Lucinda Sisk"
date: "1/4/2020"
output:
  pdf_document: default
  html_document: default
---

```{r, echo=FALSE, include=FALSE, tidy=TRUE}

list.of.packages <- c("tidyverse", "psycho", "r.jive", "here")

load_pck <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}

load_pck(list.of.packages)

path <- here()
data <- paste()
plots <- paste(path,'../../../Box/LS_Folders/CMI_ABCD/R.JIVE/plots', sep='/')

#Read in JIVE data
brain_data <- read_csv('/Users/lucindasisk/Box/LS_Folders/CMI_ABCD/CMI_Collab_Brain_Measures_1.4.19.csv')
pheno_data <- read_csv('/Users/lucindasisk/Box/LS_Folders/CMI_ABCD/phenoData_analysis_08062019.csv')
 
```

### Drop empty columns, combine data to ensure same IDs

```{r, tidy=TRUE}
#Drop ID columns; drop all columns that sum to 0
brain_datano0 <- brain_data %>%
    select(-c('subid')) %>%
    select_if(colSums(.) > 0 ) %>%
    mutate("subid" = brain_data$subid)

#Standardize (scale and center) brain data
brain_data_scaled <- brain_datano0 %>% 
    standardize() 

#Standardize (scale and center) phenotypic data
pheno_data_scaled <- pheno_data %>%
    standardize() %>%
    rename("subid" = "subjectkey")

#Merge data frames to ensure they are in same order
combined_df <- right_join(pheno_data_scaled, brain_data_scaled, by = 'subid')

###############################################################################################

new_pheno <- combined_df %>%
    select('interview_age','cbcl_scr_syn_anxdep_t':'trauma_num') %>%
    mutate_all(funs(replace_na(., 0))) #Replace NAs with 0's --> check if OK

new_brain <- combined_df %>%
    #select('area_L_1':'thickness_R_20442')
    select('area_L_1':'area_L_4254')

area_data <- read_csv('/Users/lucindasisk/Box/LS_Folders/CMI_ABCD/Mini_Area_Meas_1.10.19.csv', col_names=TRUE) %>% 
  select('area_L_1':'area_L_30') %>% 
  standardize() %>% 
  mutate_all(funs(replace_na(., 0))) %>% 
  t()

myelin_data <- read_csv('/Users/lucindasisk/Box/LS_Folders/CMI_ABCD/Mini_Myelin_Meas_1.10.19.csv', col_names=TRUE) %>% 
  select('myelin_L_1':'myelin_L_30') %>% 
  standardize() %>% 
  mutate_all(funs(replace_na(., 0))) %>% 
  t()

thick_data <- read_csv('/Users/lucindasisk/Box/LS_Folders/CMI_ABCD/Mini_Thick_Meas_1.10.19.csv', col_names=TRUE) %>% 
  select('thickness_L_1':'thickness_L_30') %>% 
  standardize() %>% 
  mutate_all(funs(replace_na(., 0))) %>% 
  t()

cbcl_data <- combined_df %>% 
  select('cbcl_scr_syn_anxdep_t':'cbcl_scr_07_stress_t') %>%
  mutate_all(funs(replace_na(., 0))) %>% 
  t()

stress_data <- combined_df %>% 
  select('su_risk_p_1': 'su_risk_p_9') %>%
  mutate_all(funs(replace_na(., 0))) %>% 
  t()

#Convert non-continuous data to factors
# new_pheno$sex <- as.factor(new_pheno$sex)
# new_pheno$site_id_l <- as.factor(new_pheno$site_id_l)

#Transpose so IDs are columns
new_pheno_mat <- t(new_pheno) 
new_brain_mat <- t(new_brain)
```
## Prepare matrices, run jive

* Data requirements: A list of two or more linked data matrices on which to perform the JIVE decomposition. These matrices must have the same column dimension, which is assumed to be common.
```{r, tidy=TRUE}
#data1 <- list(area_data, myelin_data, stress_data, thick_data, cbcl_data) 
data <- list(new_pheno_mat, new_pheno_mat)
```

```{r, tidy=TRUE}
#Run JIVE analysis

#Estimate JIVE ranks based on permutation testing (best validated)
#Row-orthogonality enforced between the joint and individual estimates and also between each individual estimate.
(try(cmi_jive_result <- jive(data, scale = TRUE)))

#Plot variance explained by individual and joint ranks, and noise
(try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d"))))

#Plot heatmaps of results
(try(cmi_jive_heatmaps <- showHeatmaps(cmi_jive_result, order_by = 0, show_all = TRUE)))

#Print Results
result_joint_rank <- cmi_jive_result$rankJ
result_individ_rank <- cmi_jive_result$rankA
```

## Results:
* Joint Rank: `r result_joint_rank`
* Individual Ranks: `r result_individ_rank`


$\\$


```{r, tidy=TRUE}
##Save images
#Save variance images
png(paste(plots, "/CMI_JIVE_VarExplained.png", sep=''),height=300,width=450)
cmi_jive_var
dev.off()

#Save heatmaps
png(paste(plots, /CMI_JIVE_Heatmaps.png", sep=''),height=465,width=705)
cmi_jive_heatmaps
dev.off()
```




