---
title: "CMI_ABCD_JIVE"
author: "Lucinda Sisk"
date: "1/12/2020"
output:
  pdf_document: default
  html_document: default
---

```{r read_in_data, echo=FALSE, include=FALSE, tidy=TRUE}

require(tidyverse)
require(r.jive)
require(dplyr)

results <- '/gpfs/milgram/project/gee_dylan/lms233/CMI_ABCD/Results'

#Read in JIVE data

# pheno_data <- read_csv('/Users/lucindasisk/Dropbox/CANDLab/Projects/CMI_Structural_ABCD/Data/LS_PhenoData_Sample1_2.13.19.csv', col_names = TRUE)
# myelin_data <- read_csv('/Users/lucindasisk/Box/LS_Folders/CANDLab/Projects/CMI_Structural_ABCD/Results/ABCD_metrics/CMI_ABCD_Sample1_myelin.csv', col_names = TRUE)
# thick_data <- read_csv('/Users/lucindasisk/Box/LS_Folders/CANDLab/Projects/CMI_Structural_ABCD/Results/ABCD_metrics/CMI_ABCD_Sample1_thickness.csv', col_names=TRUE)
# corrected_groups <- read_csv('/Users/lucindasisk/Box/LS_Folders/CANDLab/Projects/CMI_Structural_ABCD/Results/ABCD_metrics/final_data/SNF_subtyping_result_with_statistical_correction_for_pheno.csv', col_names=TRUE)
# uncorrected_groups <- read_csv('/Users/lucindasisk/Box/LS_Folders/CANDLab/Projects/CMI_Structural_ABCD/Results/ABCD_metrics/final_data/SNF_subtyping_result_without_statistical_correction_for_pheno.csv', col_names=TRUE)

  pheno_data <- read_csv('/gpfs/milgram/project/gee_dylan/lms233/CMI_ABCD/LS_PhenoData_Sample1_2.13.19.csv', col_names = TRUE)
  myelin_data <- read_csv('/gpfs/milgram/project/gee_dylan/lms233/CMI_ABCD/CMI_ABCD_Sample1_myelin.csv', col_names = TRUE)
  thick_data <- read_csv('/gpfs/milgram/project/gee_dylan/lms233/CMI_ABCD/CMI_ABCD_Sample1_thickness.csv', col_names=TRUE)
  corrected_groups <- read_csv('/gpfs/milgram/project/gee_dylan/lms233/CMI_ABCD/SNF_subtyping_result_with_statistical_correction_for_pheno.csv', col_names=TRUE)
  uncorrected_groups <- read_csv('/gpfs/milgram/project/gee_dylan/lms233/CMI_ABCD/SNF_subtyping_result_without_statistical_correction_for_pheno.csv', col_names=TRUE)

```

### Drop empty columns, combine data to ensure same IDs

```{r clean_data, tidy=TRUE}
not_all_na <- function(x) any(!is.na(x))

#Drop ID columns; drop all columns that sum to 0
myelin_data_clean <- myelin_data %>%
  select_if(not_all_na) 

#Drop ID columns; drop all columns that sum to 0
thick_data_clean <- thick_data %>%
  select_if(not_all_na) 

#Add in group info
merged_group <- full_join(corrected_groups, uncorrected_groups, by='subid') 

#Merge data frames to ensure they are in same order
m1 <- left_join(merged_group, myelin_data_clean, by='subid')
m2 <- left_join(m1, thick_data_clean, by='subid')
m3 <- left_join(m2, pheno_data, by=c('subid'='subjectkey'))
full_df <- m3

#Create groups
myelin <- full_df %>% 
  select("subid","uncorrected_group", "corrected_group","zmyelin_set1":"zmyelin_set16383")
  
thick <- full_df %>% 
  select("subid","uncorrected_group", "corrected_group","zthickness_set1":"zthickness_set16383")

pheno <- full_df %>% 
  select("subid","uncorrected_group", "corrected_group","physical_abuse_sum":"fes_p_ss_fc")

myelin_mat <- myelin %>% 
  select(-c("subid","uncorrected_group", "corrected_group")) %>% 
  t()

thick_mat <- thick %>% 
  select(-c("subid","uncorrected_group", "corrected_group")) %>% 
  t()

pheno_mat <- pheno %>% 
  select(-c("subid","uncorrected_group", "corrected_group")) %>% 
  t()

####
#Separate into corrected/uncorrected groups

group_1_myelin_cor <- myelin %>% 
  filter(corrected_group == 1) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_1_myelin_uncor <- myelin %>% 
  filter(uncorrected_group == 1) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_1_thick_cor <- thick %>% 
  filter(corrected_group == 1) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_1_thick_uncor <- thick %>% 
  filter(uncorrected_group == 1) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_2_myelin_cor <- myelin %>% 
  filter(corrected_group == 2) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_2_myelin_uncor <- myelin %>% 
  filter(uncorrected_group == 2) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_2_thick_cor <- thick %>% 
  filter(corrected_group == 2) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_2_thick_uncor <- thick %>% 
  filter(uncorrected_group == 2) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_3_myelin_cor <- myelin %>% 
  filter(corrected_group == 3) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_3_myelin_uncor <- myelin %>% 
  filter(uncorrected_group == 3) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_3_thick_cor <- thick %>% 
  filter(corrected_group == 3) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_3_thick_uncor <- thick %>% 
  filter(uncorrected_group == 3) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_4_myelin_cor <- myelin %>% 
  filter(corrected_group == 4) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_4_myelin_uncor <- myelin %>% 
  filter(uncorrected_group == 4) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_4_thick_cor <- thick %>% 
  filter(corrected_group == 4) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_4_thick_uncor <- thick %>% 
  filter(uncorrected_group == 4) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()


#Phenotypic Data
group_1_pheno_cor <- pheno %>% 
  filter(corrected_group == 1) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_1_pheno_uncor <- pheno %>% 
  filter(uncorrected_group == 1) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_2_pheno_cor <- pheno %>% 
  filter(corrected_group == 2) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_2_pheno_uncor <- pheno %>% 
  filter(uncorrected_group == 2) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_3_pheno_cor <- pheno %>% 
  filter(corrected_group == 3) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_3_pheno_uncor <- pheno %>% 
  filter(uncorrected_group == 3) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_4_pheno_cor <- pheno %>% 
  filter(corrected_group == 4) %>% 
  select(-c("subid","uncorrected_group", "corrected_group"))%>% 
  t()

group_4_pheno_uncor <- pheno %>% 
  filter(uncorrected_group == 4) %>% 
  select(-c("subid","uncorrected_group", "corrected_group")) %>% 
  t()


```


## Prepare matrices, run jive

* Data requirements: A list of two or more linked data matrices on which to perform the JIVE decomposition. These matrices must have the same column dimension, which is assumed to be common.
```{r create_data_lists, tidy=TRUE}
#Combine measures into list

data <- list(pheno_mat, myelin_mat, thick_mat)
data_1_uncor <- list(group_1_pheno_uncor, group_1_myelin_uncor, group_1_thick_uncor)
data_2_uncor <- list(group_2_pheno_uncor, group_2_myelin_uncor, group_2_thick_uncor)
data_3_uncor <- list(group_3_pheno_uncor, group_3_myelin_uncor, group_3_thick_uncor)
data_4_uncor <- list(group_4_pheno_uncor, group_4_myelin_uncor, group_4_thick_uncor)

```

## JIVE for all data

```{r run_JIVE_alldata, tidy=TRUE}
#Run JIVE analysis for ALL DATA

#Estimate JIVE ranks based on permutation testing (best validated)
#Row-orthogonality enforced between the joint and individual estimates and also between each individual estimate.
#Compute ranks
try(cmi_jive_result <- jive(data, scale = TRUE, conv="default", method='perm'))

#Get Results
result_joint_rank <- cmi_jive_result$rankJ
result_individ_rank <- cmi_jive_result$rankA

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

#Plot heatmaps of results
try(cmi_jive_heatmaps <- showHeatmaps(cmi_jive_result, order_by = 0, show_all = TRUE))

#Plot PCA 
try(cmi_jive_pca <- showPCA(cmi_jive_result, n_joint = result_joint_rank, n_indiv = c(1,1), Colors = c("#811c4e", "#fdb663")))


```

### All Data Results: Joint `r result_joint_rank`, Individual `r result_individ_rank`
