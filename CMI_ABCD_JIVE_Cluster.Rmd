---
title: "CMI_ABCD_JIVE"
author: "Lucinda Sisk"
date: "1/12/2020"
output:
  pdf_document: default
  html_document: default
---

```{r set_libraries, echo=FALSE, include=FALSE, tidy=TRUE}

require(tidyverse)
require(r.jive)
require(readxl)
require(dplyr)

```

```{r read_in_files, tidy=TRUE, echo=FALSE}

results <- '/gpfs/milgram/project/gee_dylan/lms233/CMI_ABCD/FinalData'
#results <- '/Users/lucindasisk/Box/LS_Folders/CANDLab/Projects/CMI_Structural_ABCD/Data/Final_3.11.20'

#Read in JIVE data
pheno_cols = c('subjectid','crpbi_y_ss_parent',	'crpbi_y_ss_caregiver',	'trauma_num',	'fam_hist',	'pmq_y_ss_mean',	'srpf_y_ss_ses',	'nsc_p_ss_mean_3_items',	'fes_p_ss_fc')

pheno_data1 <- read_csv(paste(results,'8_phenotypic_scores_zscore_discovery.csv', sep='/'), 
                        col_names = pheno_cols)

pheno_data2 <- read_csv(paste(results,'8_phenotypic_scores_zscore_replication.csv', sep='/'), 
                        col_names = pheno_cols)

demo_samp2 <- read_csv(paste(results,'demo_replication.csv', sep='/'), 
                        col_names = TRUE) %>% 
  rename('subjectid'=Var1, 'age'=Var2, 'sex'=Var3, 'unknown'=Var4) %>% 
  select(-c(age, sex, unknown))

#Read in myelin and thickess

myelin_data_samp1 <- read_csv(paste(results,'CMI_ABCD_Sample1_myelin.csv', sep='/'), col_names = TRUE) %>% 
  rename('subjectid'=Row)

thick_data_samp1 <- read_csv(paste(results, 'CMI_ABCD_Sample1_thickness.csv', sep='/'), col_names=TRUE)%>% 
  rename('subjectid'=Row)

#Get column names from sample1, apply to sample2
myelin_colnames <- colnames(myelin_data_samp1)[2:20485]
thick_colnames <- colnames(thick_data_samp1)[2:20485]

myelin_data_samp2 <- read_csv(paste(results,'CMI_ABCD_Sample2_myelin.csv', sep='/'), col_names = myelin_colnames)
myelin_data_samp2 <-  bind_cols(demo_samp2, myelin_data_samp2)

thick_data_samp2 <- read_csv(paste(results, 'CMI_ABCD_Sample2_thickness.csv', sep='/'), col_names=thick_colnames)
thick_data_samp2 <- bind_cols(demo_samp2, thick_data_samp2)


disc_k2 <- read_excel(paste(results,'subtype_membership.xlsx', sep='/'), sheet=1,
                     col_names=FALSE) %>% 
  rename("subid" = ...1, "group" = ...2)

repl_k2 <- read_excel(paste(results,'subtype_membership.xlsx', sep='/'), sheet=2,
                     col_names=FALSE) %>% 
  rename("subid" = ...1, "group" = ...2)

disc_k5 <- read_excel(paste(results,'subtype_membership.xlsx', sep='/'), sheet=3,
                     col_names=FALSE) %>% 
  rename("subid" = ...1, "group" = ...2)

repl_k5 <- read_excel(paste(results,'subtype_membership.xlsx', sep='/'), sheet=4,
                     col_names=FALSE)    %>% 
  rename("subid" = ...1, "group" = ...2)

```

```{r select_data, tidy=TRUE}

#Combine pheno data to n=1000
pheno_data <- rbind(pheno_data1, pheno_data2) %>% 
  arrange(subjectid)

#Select IDs for final sample
complete_samp <- pheno_data %>% 
  select(subjectid)

#Combine brain data to n=1000
myelin_data <- rbind(myelin_data_samp1, myelin_data_samp2) %>% 
  arrange(subjectid)
thick_data <- rbind(thick_data_samp1, thick_data_samp2, on='subjectid') %>% 
  arrange(subjectid)

pheno_data$subjectid <- as.character(pheno_data$subjectid)
myelin_data$subjectid <- as.character(myelin_data$subjectid)
thick_data$subjectid <- as.character(thick_data$subjectid)

```

```{r set_samples, tidy=TRUE}

disc_k2_pheno <- left_join(disc_k2, pheno_data, by = c('subid'='subjectid'))
disc_k2_myelin <- left_join(disc_k2, myelin_data, by = c('subid'='subjectid'))
disc_k2_thick <- left_join(disc_k2, thick_data, by = c('subid'='subjectid'))

repl_k2_pheno <- left_join(repl_k2, pheno_data, by = c('subid'='subjectid'))
repl_k2_myelin <- left_join(repl_k2, myelin_data, by = c('subid'='subjectid'))
repl_k2_thick <- left_join(repl_k2, thick_data, by = c('subid'='subjectid'))

disc_k5_pheno <- left_join(disc_k5, pheno_data, by = c('subid'='subjectid'))
disc_k5_myelin <- left_join(disc_k5, myelin_data, by = c('subid'='subjectid'))
disc_k5_thick <- left_join(disc_k5, thick_data, by = c('subid'='subjectid'))

repl_k5_pheno <- left_join(repl_k5, pheno_data, by = c('subid'='subjectid'))
repl_k5_myelin <- left_join(repl_k5, myelin_data, by = c('subid'='subjectid'))
repl_k5_thick <- left_join(repl_k5, thick_data, by = c('subid'='subjectid'))

```

## Set group info for Discovery Data, K=2

```{r, tidy=TRUE}

#Discovery, K=2
#Set Group 1
group1_pheno <- disc_k2_pheno %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_myelin <- disc_k2_myelin %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_thick <- disc_k2_thick %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_data <- list(group1_pheno, group1_myelin, group1_thick)  

#Set Group 2
group2_pheno <- disc_k2_pheno %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_myelin <- disc_k2_myelin %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_thick <- disc_k2_thick %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_data <- list(group2_pheno, group2_myelin, group2_thick)  

```

### Run JIVE for Discovery Data, K=2, Group 1

```{r, tidy=TRUE}

## RUN JIVE for Group 1
try(cmi_jive_result <- jive(group1_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

```

### Run JIVE for Discovery Data, K=2, Group 2

```{r, tidy=TRUE}
## RUN JIVE for Group 2
try(cmi_jive_result <- jive(group1_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

```

## Set Group Info for Replication Data, K=2

```{r, tidy=TRUE}

#Replication, K=2
#Set Group 1
group1_pheno <- repl_k2_pheno %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_myelin <- repl_k2_myelin %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_thick <- repl_k2_thick %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_data <- list(group1_pheno, group1_myelin, group1_thick)  

#Set Group 2
group2_pheno <- repl_k2_pheno %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_myelin <- repl_k2_myelin %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_thick <- repl_k2_thick %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_data <- list(group2_pheno, group2_myelin, group2_thick)  

```

### Run JIVE for Replication Data, K=2, Group 1

```{r, tidy=TRUE}
## RUN JIVE for Group 1
try(cmi_jive_result <- jive(group1_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

```

### Run JIVE for Replication Data, K=2, Group 2
```{r, tidy=TRUE}

## RUN JIVE for Group 2
try(cmi_jive_result <- jive(group1_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

```

## Set Group Info for Discovery Data, K=5

```{r, tidy=TRUE}

#Discovery, K=2
#Set Group 1
group1_pheno <- disc_k5_pheno %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_myelin <- disc_k5_myelin %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_thick <- disc_k5_thick %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_data <- list(group1_pheno, group1_myelin, group1_thick)  

#Set Group 2
group2_pheno <- disc_k5_pheno %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_myelin <- disc_k5_myelin %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_thick <- disc_k5_thick %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_data <- list(group2_pheno, group2_myelin, group2_thick)  

#Set Group 3
group3_pheno <- disc_k5_pheno %>% 
  filter(group == 3) %>% 
  select(-c(subid, group)) %>% 
  t()

group3_myelin <- disc_k5_myelin %>% 
  filter(group == 3) %>% 
  select(-c(subid, group)) %>% 
  t()

group3_thick <- disc_k5_thick %>% 
  filter(group == 3) %>% 
  select(-c(subid, group)) %>% 
  t()

group3_data <- list(group3_pheno, group3_myelin, group3_thick)  

#Set Group 4
group4_pheno <- disc_k5_pheno %>% 
  filter(group == 4) %>% 
  select(-c(subid, group)) %>% 
  t()

group4_myelin <- disc_k5_myelin %>% 
  filter(group == 4) %>% 
  select(-c(subid, group)) %>% 
  t()

group4_thick <- disc_k5_thick %>% 
  filter(group == 4) %>% 
  select(-c(subid, group)) %>% 
  t()

group4_data <- list(group4_pheno, group4_myelin, group4_thick)  

#Set Group 5
group5_pheno <- disc_k5_pheno %>% 
  filter(group == 5) %>% 
  select(-c(subid, group)) %>% 
  t()

group5_myelin <- disc_k5_myelin %>% 
  filter(group == 5) %>% 
  select(-c(subid, group)) %>% 
  t()

group5_thick <- disc_k5_thick %>% 
  filter(group == 5) %>% 
  select(-c(subid, group)) %>% 
  t()

group5_data <- list(group5_pheno, group5_myelin, group5_thick)  
```

### Run JIVE for Discovery Data, K=5, Group 1

```{r, tidy=TRUE}

#################################
## RUN JIVE for Group 1
try(cmi_jive_result <- jive(group1_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

```

### Run JIVE for Discovery Data, K=5, Group 2

```{r, tidy=TRUE}
#################################
## RUN JIVE for Group 2
try(cmi_jive_result <- jive(group1_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

#################################
```

### Run JIVE for Discovery Data, K=5, Group 3

```{r, tidy=TRUE}

## RUN JIVE for Group 3
try(cmi_jive_result <- jive(group3_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

#################################
```

### Run JIVE for Discovery Data, K=5, Group 4

```{r, tidy=TRUE}

## RUN JIVE for Group 4
try(cmi_jive_result <- jive(group4_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))
#################################
```

### Run JIVE for Discovery Data, K=5, Group 5

```{r, tidy=TRUE}

## RUN JIVE for Group 5
try(cmi_jive_result <- jive(group5_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

#################################
```

## Set Group Info for Replication Data, K=5

```{r, tidy=TRUE}

#Replication, K=5
#Set Group 1
group1_pheno <- repl_k5_pheno %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_myelin <- repl_k5_myelin %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_thick <- repl_k5_thick %>% 
  filter(group == 1) %>% 
  select(-c(subid, group)) %>% 
  t()

group1_data <- list(group1_pheno, group1_myelin, group1_thick)  

#Set Group 2
group2_pheno <- repl_k5_pheno %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_myelin <- repl_k5_myelin %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_thick <- repl_k5_thick %>% 
  filter(group == 2) %>% 
  select(-c(subid, group)) %>% 
  t()

group2_data <- list(group2_pheno, group2_myelin, group2_thick)  

#Set Group 3
group3_pheno <- repl_k5_pheno %>% 
  filter(group == 3) %>% 
  select(-c(subid, group)) %>% 
  t()

group3_myelin <- repl_k5_myelin %>% 
  filter(group == 3) %>% 
  select(-c(subid, group)) %>% 
  t()

group3_thick <- repl_k5_thick %>% 
  filter(group == 3) %>% 
  select(-c(subid, group)) %>% 
  t()

group3_data <- list(group3_pheno, group3_myelin, group3_thick)  

#Set Group 4
group4_pheno <- repl_k5_pheno %>% 
  filter(group == 4) %>% 
  select(-c(subid, group)) %>% 
  t()

group4_myelin <- repl_k5_myelin %>% 
  filter(group == 4) %>% 
  select(-c(subid, group)) %>% 
  t()

group4_thick <- repl_k5_thick %>% 
  filter(group == 4) %>% 
  select(-c(subid, group)) %>% 
  t()

group4_data <- list(group4_pheno, group4_myelin, group4_thick)  

#Set Group 5
group5_pheno <- repl_k5_pheno %>% 
  filter(group == 5) %>% 
  select(-c(subid, group)) %>% 
  t()

group5_myelin <- repl_k5_myelin %>% 
  filter(group == 5) %>% 
  select(-c(subid, group)) %>% 
  t()

group5_thick <- repl_k5_thick %>% 
  filter(group == 5) %>% 
  select(-c(subid, group)) %>% 
  t()

group5_data <- list(group5_pheno, group5_myelin, group5_thick)  
```

### Run JIVE for Discovery Data, K=5, Group 1

```{r, tidy=TRUE}

#################################
## RUN JIVE for Group 1
try(cmi_jive_result <- jive(group1_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

```

### Run JIVE for Discovery Data, K=5, Group 2

```{r, tidy=TRUE}
#################################
## RUN JIVE for Group 2
try(cmi_jive_result <- jive(group1_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

#################################
```

### Run JIVE for Discovery Data, K=5, Group 3

```{r, tidy=TRUE}

## RUN JIVE for Group 3
try(cmi_jive_result <- jive(group3_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

#################################
```

### Run JIVE for Discovery Data, K=5, Group 4

```{r, tidy=TRUE}

## RUN JIVE for Group 4
try(cmi_jive_result <- jive(group4_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))
#################################
```

### Run JIVE for Discovery Data, K=5, Group 5

```{r, tidy=TRUE}

## RUN JIVE for Group 5
try(cmi_jive_result <- jive(group5_data, scale = TRUE, conv="default", method='perm'))

#Plot variance explained by individual and joint ranks, and noise
try(cmi_jive_var <- showVarExplained(cmi_jive_result, col = c("#811c4e", "#fdb663", "#37486d")))

#################################
